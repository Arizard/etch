<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {{ $description := .Params.description | default .Site.Params.description -}}
    {{ with $description -}}
    <meta name="description" content="{{ . }}">
    {{ end }}
    {{ $keywords := .Params.keywords | default .Site.Params.keywords -}}
    {{ with $keywords -}}
    <meta name="keywords" content="{{ if reflect.IsSlice . }}{{ delimit . ", " }}{{ else }}{{ . }}{{ end }}">
    {{ end }}
    {{ with .OutputFormats.Get "rss" -}}
        {{ printf `<link rel="%s" type="%s" href="%s" title="%s">` .Rel .MediaType.Type .Permalink $.Site.Title | safeHTML }}
    {{ end -}}

    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ff4757" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#ff4757" />

    <script>
        window.siteConfig = {
            apiURL: {{ if hugo.IsServer }}{{ "http://localhost:8080" }}{{ else }}{{ "https://backend.less.coffee" }}{{ end }},
        };

        window.articleConfig = {
            articleID: {{ .Page.Slug | default .Page.Path }},
        };

        {{ if ne .Page.Params.nocomment true }}
        {{ $jsComments := resources.Get "js/comments.js" | js.Build | minify }}
        {{ $jsComments.Content | safeJS }}
        {{ end }}

        addEventListener("load", async () => {
            const replyCountSpans = document.querySelectorAll('[data-article-id-for-reply-count]');
            if (replyCountSpans.length === 0) return;

            try {
                const articleParams = Array.from(replyCountSpans, el => 
                    `article=${btoa(el.dataset.articleIdForReplyCount)}`
                ).join('&');
                
                const response = await fetch(`${window.siteConfig.apiURL}/gomments/articles/replies/stats?${articleParams}`);
                const { stats } = await response.json();

                replyCountSpans.forEach(el => {
                    const count = stats[btoa(el.dataset.articleIdForReplyCount)]?.count;
                    if (count) {
                        el.innerHTML = `&nbsp;&mdash;&nbsp;${count} repl${count === 1 ? 'y' : 'ies'}`;
                    }
                });
            } catch (error) {
                console.error('Failed to load reply counts:', error);
            }
        });
    </script>

    {{ $resources := slice -}}
    {{ $resources = $resources | append (resources.Get "css/main.css") -}}
    {{ $resources = $resources | append (resources.Get "css/min770px.css") -}}
    {{ if .Site.Params.highlight -}}
        {{ $resources = $resources | append (resources.Get "css/syntax.css") -}}
    {{ end -}}
    {{ $customSCSS := resources.Get "css/all.scss" }}
    {{ $customStyle := $customSCSS | css.Sass | minify }}
    {{ $css := $resources | resources.Concat "css/style.css" | minify }}

    <style>
        {{ $css.Content | safeCSS }}
        {{ $customStyle.Content | safeCSS }}
    </style>

    <title>{{ if eq  .Title  .Site.Title }}{{ .Site.Title }}{{ else }}{{ with .Title }}{{.}} - {{ end }}{{ .Site.Title }}{{ end }}</title>
</head>
