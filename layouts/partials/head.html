<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {{ $description := .Summary | default .Site.Params.description -}}
    {{ with $description -}}
    <meta name="description" content="{{ . }}">
    {{ end }}
    {{ $keywords := .Params.keywords | default .Site.Params.keywords -}}
    {{ with .OutputFormats.Get "rss" -}}
        {{ printf `<link rel="%s" type="%s" href="%s" title="%s">` .Rel .MediaType.Type .Permalink $.Site.Title | safeHTML }}
    {{ end -}}

    {{- $title := .Site.Title -}}
    {{- if .Data.Term -}} <!-- term page -->
        {{- $title = fmt.Printf "%s: %s - %s" (.Data.Singular | title) (.Title) (.Site.Title) -}}
    {{ else if eq  .Title  .Site.Title }} <!-- home page -->
        {{- $title = .Site.Title -}}
    {{ else if .Title }} <!-- post pages -->
        {{- $title = fmt.Printf "%s - %s" (.Title) (.Site.Title) -}}
    {{ else }}
        {{- $title = .Site.Title -}}
    {{ end }}

    <title>{{ $title }}</title>

    <meta property="og:title" content="{{ $title }}">
    {{ with $description -}}
    <meta property="og:description" content="{{ . }}">
    {{ end -}}
    {{ if .Page.Params.hero -}}
    {{ with .Page.Resources.Get .Page.Params.hero -}}
    <meta property="og:image" content="{{ .Permalink }}">
    {{ end -}}
    {{ end -}}
    <meta property="og:url" content="{{- .Page.Permalink -}}">
    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ $title }}">
    {{ with $description -}}
    <meta name="twitter:description" content="{{ . }}">
    {{ end -}}
    {{ if .Page.Params.hero -}}
    {{ with .Page.Resources.Get .Page.Params.hero -}}
    <meta name="twitter:image" content="{{ .Permalink }}">
    {{ end -}}
    {{ end -}}

    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f1f2eb" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#002029" />

    <script>
        window.siteConfig = {
            apiURL: {{ if hugo.IsServer }}{{ "http://localhost:8080" }}{{ else }}{{ "https://backend.less.coffee" }}{{ end }},
        };

        window.articleConfig = {
            articleID: {{ .Page.Slug | default .Page.Path }},
        };

        {{ if ne .Page.Params.nocomment true }}
        {{ $jsComments := resources.Get "js/comments.js" | js.Build | minify }}
        {{ $jsComments.Content | safeJS }}
        {{ end }}

        const iconComment = `{{- partial "svg/comment.html" . -}}`;

        addEventListener("load", async () => {
            const replyCountSpans = document.querySelectorAll('[data-article-id-for-reply-count]');
            if (replyCountSpans.length === 0) return;

            try {
                const articleParams = Array.from(replyCountSpans, el =>
                    `article=${btoa(el.dataset.articleIdForReplyCount)}`
                ).join('&');

                const response = await fetch(`${window.siteConfig.apiURL}/gomments/articles/replies/stats?${articleParams}`);
                const { stats } = await response.json();

                replyCountSpans.forEach(el => {
                    const count = stats[btoa(el.dataset.articleIdForReplyCount)]?.count;
                    if (count) {
                        el.innerHTML = `${iconComment} ${count} ${count == 1 ? "reply" : "replies"}`;
                    }
                });
            } catch (error) {
                console.error('Failed to load reply counts:', error);
            }
        });
    </script>

    {{- if not hugo.IsServer -}}
    <script defer src="https://cloud.umami.is/script.js" data-website-id="f6e489e0-5149-4d45-b189-50b70706a490"></script>
    {{- end -}}

    {{ $myCSS := slice -}}
    {{ $myCSS = $myCSS | append (resources.Get "css/main.css") -}}
    {{ $myCSS = $myCSS | append (resources.Get "css/min770px.css") -}}
    {{ $css := $myCSS | resources.Concat "css/style.css" | minify }}

    {{ $mySCSS := slice -}}
    {{ $mySCSS := $mySCSS | append (resources.Get "css/all.scss") -}}
    {{ $scss := $mySCSS | resources.Concat "css/style2.css" | css.Sass | minify }}

    <style>
        {{ $css.Content | safeCSS }}
        {{ $scss.Content | safeCSS }}

        {{ if .Site.Params.highlight -}}
            {{ $cssSyntaxDark := resources.Get "css/syntax-dark.css" }}
            {{ $cssSyntaxLight := resources.Get "css/syntax-light.css" }}

            @media (prefers-color-scheme: light) {
                {{ $cssSyntaxLight.Content | safeCSS }}
            }
            @media (prefers-color-scheme: dark) {
                {{ $cssSyntaxDark.Content | safeCSS }}
            }
        {{ end -}}
    </style>
</head>
